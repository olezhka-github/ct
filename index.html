<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- –û–±–º–µ–∂–µ–Ω–Ω—è –¥–∂–µ—Ä–µ–ª —Ä–µ—Å—É—Ä—Å—ñ–≤ —á–µ—Ä–µ–∑ CSP -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' https://cdn.jsdelivr.net;">-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WCS –ú–µ—Å–µ–Ω–¥–∂–µ—Ä - —Ç–≤–æ—Ä—ñ–Ω–Ω—è xaotiq</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Alertify –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º SRI (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css" unsafe-inline/>
</head>
<body>
  <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –≤—Ö–æ–¥—É/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
  <div class="form" id="login-section">
    <p id="heading">WCS</p>
    <p class="subhead">–≤–∏–∫–æ–Ω—É—é—á–∏ –±—É–¥—å —è–∫—ñ –¥—ñ—ó –≤ –º–µ—Å–µ–Ω–∂–µ—Ä—ñ –≤–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ <a href="—É–º–æ–≤–∏_–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è/index.html">–£–º–æ–≤–∞–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</a></p>
    <div class="field">
      <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path>
      </svg>
      <input autocomplete="off" placeholder="–ù—ñ–∫–Ω–µ–π–º" class="input-field" type="text" id="username">
    </div>
    <div class="field">
      <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
      </svg>
      <input placeholder="–ü–∞—Ä–æ–ª—å" class="input-field" type="password" id="password">
    </div>
    <div class="btn">
      <button class="button1" id="login-button">–í—Ö—ñ–¥</button>
      <button class="button2" id="register-button">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
    </div>
  </div>
  
  <!-- –°–µ–∫—Ü—ñ—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç—É -->
  <div id="chat-section" class="hidden gcard">
    <h3>–í—ñ—Ç–∞—é, <span id="user-welcome"></span>!</h3>
    <div id="chat-area">
      <div id="messages"></div>
    </div>
    <div id="send-message">
      <input type="text" id="message" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
      <button id="send-button">üì©</button>
    </div>
    <div id="sticker-area">
      <div id="sticker-gallery"></div>
      <div id="upload-form">
        <button type="button" id="sticker-button">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç—ñ–∫–µ—Ä</button>
      </div>
    </div>
    <div id="call-controls" style="margin-top: 10px;">
      <!-- –î–æ–¥–∞–π—Ç–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∑–≤—ñ–Ω–∫–∞–º–∏, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ -->
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –∞–¥–º—ñ–Ω–ø–∞–Ω–µ–ª—ñ -->
  <div class="hidden gcard" id="adminpanelen">
    <h3>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å. –ü–æ–≤–æ–¥—å—Å—è –∞–¥–µ–∫–≤–∞—Ç–Ω–æ, –∞ —Ç–æ –≤—ñ–¥–ª–µ—Ç–∏—à —è–∫ –≤—Å—ñ —à–∞—Ö—Ä–∞—ó</h3>
    <div id="ban-panel">
      <label for="user-select">–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</label>
      <select id="usernameToBan"></select>
      <br><br>
      <button id="banButton" onclick="TryToBanUser()">–ó–∞–±–∞–Ω–∏—Ç–∏</button>
      <button id="unbanButton" onclick="TryToBanUser()">–†–æ–∑–±–∞–Ω–∏—Ç–∏</button>
    </div>
  </div>

  <!-- –°–µ–∫—Ü—ñ—è –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å -->
  <div class="hidden gcard" id="private-section">
    <div id="messagesP"></div>
    <p>–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: <span id="chosen-user"></span></p>
    <select id="checkbox-users"></select>
    <div id="send-message">
      <input type="text" id="prvamsg" placeholder="–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
      <button id="send-private">üì©</button>
    </div>
  </div>

  <!-- –°–µ–∫—Ü—ñ—è –ø—Ä–æ—Ñ—ñ–ª—é -->
  <div class="hidden gcard" id="profile-section">
    <h3>–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: <span id="profile-username"></span></h3>
    <h4>–ü—Ä–æ —Å–µ–±–µ</h4>
    <p id="profile-about">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    <textarea id="edit-about" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–µ–±–µ..." rows="4" style="width: 100%;"></textarea>
    <button id="save-about" style="margin-top: 10px; padding: 10px 20px;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä—É -->
    <h4 style="margin-top: 20px;">–í—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä</h4>
    <div id="video-avatar-section">
      <input type="file" id="video-avatar-upload" accept="video/*">
      <video id="video-avatar-preview" width="100" height="100" autoplay loop muted style="display: none; margin-top: 10px;"></video>
      <button id="save-video-avatar" style="margin-top: 10px; padding: 10px 20px;">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä</button>
    </div>
    <!-- –ë–ª–æ–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä—É -->
    <h4 style="margin-top: 20px;">–°—Ç–∞—Ç–∏—á–Ω–∏–π –∞–≤–∞—Ç–∞—Ä</h4>
    <div id="static-avatar-section">
      <input type="file" id="static-avatar-upload" accept="image/*">
      <img id="static-avatar-preview" width="100" height="100" style="display: none; margin-top: 10px;" alt="Preview">
      <button id="save-static-avatar" style="margin-top: 10px; padding: 10px 20px;">–ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç–∏—á–Ω–∏–π –∞–≤–∞—Ç–∞—Ä</button>
    </div>
  </div>

  <!-- –°–µ–∫—Ü—ñ—è –ø—Ä–µ—Ñ—ñ–∫—Å—ñ–≤ -->
  <div id="prefix-section" class="hidden gcard">
    <h3>–û–±–µ—Ä—ñ—Ç—å —Å–≤—ñ–π –ø—Ä–µ—Ñ—ñ–∫—Å:</h3>
    <div id="prefix-options">
      <label><input type="radio" name="prefix" value="[üíôüíõ]"> üíôüíõ</label>
      <label><input type="radio" name="prefix" value="[üî•]"> üî•</label>
      <label><input type="radio" name="prefix" value="[‚≠ê]"> ‚≠ê</label>
      <label><input type="radio" name="prefix" value="[üíé]"> üíé</label>
      <label><input type="radio" name="prefix" value=""> (–ë–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É)</label>
      <label><input type="radio" name="prefix" value="[–ß–Ü–ù–ê–ó–ï–°]"> –ß–Ü–ù–ê–ó–ï–°</label>
      <label><input type="radio" name="prefix" value="[–∫–µ—Ñ—Ç–µ–º–µ]"> –∫–µ—Ñ—Ç–µ–º–µ</label>
      <label><input type="radio" name="prefix" value="[–ü–æ—Ç—É–∂–Ω–æ]"> –ü–æ—Ç—É–∂–Ω–æ</label>
      <label><input type="radio" name="prefix" value="[–∞–±–∞—é–¥–Ω–∞]"> –∞–±–∞—é–¥–Ω–∞</label>
      <label><input type="radio" name="prefix" value="[UKRaine]"> UKRaine</label>
    </div>
    <button id="save-prefix" class="flip-card__btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–µ—Ñ—ñ–∫—Å</button>
  </div>

  <!-- Radio-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤ -->
  <div id="radio-section" class="hidden radio-inputs" style="display: none;">
    <label class="radio">
      <input type="radio" name="radio" checked value="forum">
      <span class="name">–§–æ—Ä—É–º</span>
    </label>
    <label class="radio">
      <input type="radio" name="radio" value="private">
      <span class="name">–ü—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</span>
    </label>
    <label class="radio">
      <input type="radio" name="radio" value="profile">
      <span class="name">–ü—Ä–æ—Ñ—ñ–ª—å</span>
    </label>
    <label class="radio">
      <input type="radio" name="radio" value="prefix">
      <span class="name">–ü—Ä–µ—Ñ—ñ–∫—Å–∏</span>
    </label>
    <br>
    <label class="radio hidden" id="ban-radio">
      <input type="radio" name="radio" value="bans">
      <span class="nameA">–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</span>
    </label>
    <label class="radio" id="wv-radio" onclick="window.location = 'https://wcsvoicebeta.onrender.com'">
      <input type="radio" name="radio" value="wcsvoice">
      <span class="name">–í—ñ–¥–µ–æ –∑–≤'—è–∑–æ–∫</span>
    </label>
  </div>

  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Alertify —Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç—É (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ –æ–∫—Ä–µ–º–∏–π —Ñ–∞–π–ª) -->
  <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2935912598910824"
     crossorigin="anonymous"></script>
  <script>
    /*****************************************************************
     *           1. –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è IP-–∞–¥—Ä–µ—Å–∏          *
     *****************************************************************/
    let ws;
    let currentUsername;
    let currentPrefix = "";
    let currentVideoAvatar = "";
    let currentStaticAvatar = "";
    let clientIP = ""; // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è IP

    // –û—Ç—Ä–∏–º—É—î–º–æ IP-–∞–¥—Ä–µ—Å—É –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    fetch('https://api.ipify.org?format=json')
      .then(response => response.json())
      .then(data => {
        clientIP = data.ip;
        console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ IP –∫–ª—ñ—î–Ω—Ç–∞:', clientIP);
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è IP:', error);
      });

    /*****************************************************************
     *            2. DOM-–µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è           *
     *****************************************************************/
    const loginSection = document.getElementById('login-section');
    const chatSection = document.getElementById('chat-section');
    const privateSection = document.getElementById('private-section');
    const profileSection = document.getElementById('profile-section');
    const prefixSection = document.getElementById('prefix-section');
    const messagesDiv = document.getElementById('messages');
    const messagesP = document.getElementById('messagesP');
    const loginButton = document.getElementById('login-button');
    const sendButton = document.getElementById('send-button');
    const stickerButton = document.getElementById('sticker-button');
    const userWelcome = document.getElementById('user-welcome');
    const registerButton = document.getElementById('register-button');
    const radioSectionDiv = document.getElementById('radio-section');
    const sendPrivate = document.getElementById('send-private');
    const prvmsg = document.getElementById('prvamsg');
    const chosenUser = document.getElementById('chosen-user');
    const profileUsername = document.getElementById('profile-username');
    const profileAbout = document.getElementById('profile-about');
    const editAbout = document.getElementById('edit-about');
    const saveAbout = document.getElementById('save-about');
    const banRadio = document.getElementById('ban-radio');
    const admin = document.getElementById('adminpanelen');
    const usernameToBan = document.getElementById('usernameToBan');
    const savePrefixBtn = document.getElementById('save-prefix');
    const checkboxUsers = document.getElementById('checkbox-users');

    // –ï–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –≤—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä—É
    const videoAvatarUpload = document.getElementById('video-avatar-upload');
    const videoAvatarPreview = document.getElementById('video-avatar-preview');
    const saveVideoAvatarButton = document.getElementById('save-video-avatar');

    // –ï–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä—É
    const staticAvatarUpload = document.getElementById('static-avatar-upload');
    const staticAvatarPreview = document.getElementById('static-avatar-preview');
    const saveStaticAvatarButton = document.getElementById('save-static-avatar');

    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å–µ–∫—Ü—ñ–π
    privateSection.style.display = 'none';
    profileSection.style.display = 'none';
    prefixSection.style.display = 'none';

    // WebSocket URL (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ wss:// –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è)
    const url = "wss:/ctserver.onrender.com/"; 

    /*****************************************************************
     * 3. –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—ñ–≤ —á–µ—Ä–µ–∑ radio-–∫–Ω–æ–ø–∫–∏ (—Ñ–æ—Ä—É–º/–ø—Ä–∏–≤–∞—Ç/–ø—Ä–æ—Ñ—ñ–ª—å/...) 
     *****************************************************************/
    document.querySelectorAll('input[name="radio"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const selectedValue = document.querySelector('input[name="radio"]:checked').value;
        chatSection.style.display = 'none';
        privateSection.style.display = 'none';
        profileSection.style.display = 'none';
        prefixSection.style.display = 'none';
        admin.style.display = 'none';
        if (selectedValue === "forum") {
          chatSection.style.display = 'flex';
        } else if (selectedValue === "private") {
          privateSection.style.display = 'flex';
        } else if (selectedValue === "profile") {
          profileSection.style.display = 'flex';
          loadProfile();
        } else if (selectedValue === "prefix") {
          prefixSection.style.display = 'flex';
        } else if (selectedValue === "bans") {
          admin.style.display = 'flex';
        }
      });
    });

    /*****************************************************************
     *          4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–º—ñ–Ω–∞ –ø—Ä–µ—Ñ—ñ–∫—Å–∞ (prefix)             *
     *****************************************************************/
    savePrefixBtn.addEventListener('click', () => {
      const selected = document.querySelector('input[name="prefix"]:checked');
      if (selected) {
        currentPrefix = selected.value;
        alertify.success('–ü—Ä–µ—Ñ—ñ–∫—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + (currentPrefix ? currentPrefix : "(–±–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É)"));
      } else {
        alertify.error('–û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ—Ñ—ñ–∫—Å');
      }
    });

    /*****************************************************************
     * 5. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä—É                   *
     *****************************************************************/
    videoAvatarUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const videoURL = URL.createObjectURL(file);
        videoAvatarPreview.src = videoURL;
        videoAvatarPreview.style.display = 'block';
        currentVideoAvatar = videoURL;
      }
    });

    saveVideoAvatarButton.addEventListener('click', () => {
      if (currentVideoAvatar) {
        alertify.success("–í—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
        // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤—ñ–¥–µ–æ –∞–≤–∞—Ç–∞—Ä—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      } else {
        alertify.error("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–µ–æ");
      }
    });

    /*****************************************************************
     * 6. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä—É (–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è) *
     *****************************************************************/
    staticAvatarUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const imageURL = URL.createObjectURL(file);
        staticAvatarPreview.src = imageURL;
        staticAvatarPreview.style.display = 'block';
      }
    });

    saveStaticAvatarButton.addEventListener('click', () => {
      if (staticAvatarUpload.files.length > 0) {
        const file = staticAvatarUpload.files[0];
        const formData = new FormData();
        formData.append("avatar", file);
        formData.append("username", currentUsername); // –ü–µ—Ä–µ–¥–∞—î–º–æ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

        fetch('/upload_static_avatar', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î { success: true/false, message: "...", avatarUrl: "..." }
          if (data.success) {
            alertify.success(data.message);
            currentStaticAvatar = data.avatarUrl;
          } else {
            alertify.error(data.message);
          }
        })
        .catch(err => {
          console.error(err);
          alertify.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä—É");
        });
      } else {
        alertify.error("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è");
      }
    });

    /*****************************************************************
     *       7. –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è, –í—Ö—ñ–¥, –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è           *
     *****************************************************************/
    // 7.1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
    registerButton.addEventListener('click', () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) {
        alertify.error('–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó');
        return;
      }
      ws = new WebSocket(url);
      ws.onopen = () => {
        ws.send(JSON.stringify({ 
          action: 'create_account', 
          username, 
          password,
          ip: clientIP // –ù–∞–¥—Å–∏–ª–∞—î–º–æ IP
        }));
      };
      ws.onmessage = (event) => {
        const response = JSON.parse(event.data);
        if (response.action === 'createAccount') {
          if (response.success) {
            alertify.success('–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å, —Ç–µ–ø–µ—Ä –º–æ–∂–µ—Ç–µ —É–≤—ñ–π—Ç–∏.');
          } else {
            alertify.error(response.message || '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó');
          }
        }
      };
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    });

    // 7.2. –í—Ö—ñ–¥
    loginButton.addEventListener('click', () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) {
        alertify.error('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –≤—Ö–æ–¥—É');
        return;
      }
      ws = new WebSocket(url);
      ws.onopen = () => {
        ws.send(JSON.stringify({ 
          action: 'login', 
          username, 
          password,
          ip: clientIP // –ù–∞–¥—Å–∏–ª–∞—î–º–æ IP
        }));
      };
      ws.onmessage = (event) => {
        const response = JSON.parse(event.data);
        if (response.action === 'login') {
          if (response.success) {
            currentUsername = username;
            loginSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
            privateSection.classList.remove('hidden');
            radioSectionDiv.style.display = 'flex';
            userWelcome.textContent = currentUsername;
            profileUsername.textContent = currentUsername;

            // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á - –∞–¥–º—ñ–Ω/–º–æ–¥–µ—Ä, –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å
            if (['hideyoshi.xaotiq', 'moderator.roman'].includes(currentUsername)) {
              banRadio.classList.remove('hidden');
            } else {
              if(banRadio.parentNode) banRadio.parentNode.removeChild(banRadio);
              if(admin.parentNode) admin.parentNode.removeChild(admin);
            }
            loadFriendList();
            loadChatHistory();
          } else {
            alertify.error(response.message);
          }
        }
        // 7.3. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        else if (response.action === 'new_message') {
          if (response.type === 'sticker') {
            displaySticker(response.username, response.stickerUrl);
          } else {
            displayMessage(response.username, response.message, response.prefix, response.staticAvatar);
          }
        }
        // 7.4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É
        else if (response.action === 'loadChatHistory') {
          response.chatHistory.forEach(msg => {
            if (msg.type === 'message') {
              displayMessage(msg.username, msg.message, msg.prefix, msg.staticAvatar);
            } else if (msg.type === 'sticker') {
              displaySticker(msg.username, msg.stickerUrl);
            }
          });
        }
        // 7.5. –ü—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        else if (response.action === 'private_message') {
          if (response.recipient === currentUsername) {
            displayPrivate(response.from, response.message, response.staticAvatar);
          }
        }
        // 7.6. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
        else if (response.action === 'get_profile') {
          if (response.success) {
            profileAbout.textContent = '–ü—Ä–æ —Å–µ–±–µ = ' + (response.about || '–ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó');
            editAbout.value = response.about || '';
          } else {
            profileAbout.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é';
          }
        }
        // 7.7. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
        else if (response.action === 'update_profile') {
          if (response.success) {
            profileAbout.textContent = '–ü—Ä–æ —Å–µ–±–µ = ' + (response.about || '–ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó');
            alertify.success('–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ');
          } else {
            alertify.error(response.message);
          }
        }
        // 7.8. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        else if (response.action === 'loadUserList') {
          loadUserList(response.users);
        }
      };
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    });

    // 7.9. –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    sendButton.addEventListener('click', () => {
      const message = document.getElementById('message').value.trim();
      if (message) {
        ws.send(JSON.stringify({ 
          action: 'send_message', 
          username: currentUsername, 
          message, 
          prefix: currentPrefix,
          staticAvatar: currentStaticAvatar,
          ip: clientIP // –ù–∞–¥—Å–∏–ª–∞—î–º–æ IP
        }));
        document.getElementById('message').value = '';
      }
    });

    // 7.10. –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä–∞
    stickerButton.addEventListener('click', () => {
      const stickerUrl = prompt("–í—Å—Ç–∞–≤—Ç–µ URL-–∞–¥—Ä–µ—Å—É —Å—Ç—ñ–∫–µ—Ä–∞:");
      if (stickerUrl && stickerUrl.trim()) {
        ws.send(JSON.stringify({ 
          action: 'send_sticker', 
          username: currentUsername, 
          stickerUrl,
          ip: clientIP // –ù–∞–¥—Å–∏–ª–∞—î–º–æ IP
        }));
      }
    });

    // 7.11. –ü—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    document.getElementById('checkbox-users').addEventListener('change', function() {
      document.getElementById('chosen-user').textContent = this.value;
    });
    sendPrivate.addEventListener('click', () => {
      const message = document.getElementById('prvamsg').value.trim();
      const recipient = document.getElementById('chosen-user').textContent.trim();
      if (message && recipient) {
        ws.send(JSON.stringify({ 
          action: 'private_message', 
          username: currentUsername, 
          recipient, 
          message, 
          prefix: currentPrefix,
          staticAvatar: currentStaticAvatar,
          ip: clientIP // –ù–∞–¥—Å–∏–ª–∞—î–º–æ IP
        }));
        // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –≤–ª–∞—Å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥—Ä–∞–∑—É
        displayPrivate(currentUsername, message, currentStaticAvatar);
        document.getElementById('prvamsg').value = '';
      } else {
        alertify.error('–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –Ω–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
      }
    });

    /*****************************************************************
     *        8. –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Ç–∞ —Å—Ç—ñ–∫–µ—Ä—ñ–≤ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ      *
     *****************************************************************/
    function displayMessage(username, message, prefix, avatar) {
      const p = document.createElement('p');
      const avatarContainer = document.createElement('span');

      // –Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ - –ø–æ–∫–∞–∑—É—î–º–æ –π–æ–≥–æ –∞–≤–∞—Ç–∞—Ä/–≤—ñ–¥–µ–æ
      if (username === currentUsername) {
        if (currentVideoAvatar) {
          const videoEl = document.createElement('video');
          videoEl.src = currentVideoAvatar;
          videoEl.width = 50;
          videoEl.height = 50;
          videoEl.autoplay = true;
          videoEl.loop = true;
          videoEl.muted = true;
          videoEl.style.marginRight = "5px";
          avatarContainer.appendChild(videoEl);
        } else if (currentStaticAvatar) {
          const img = document.createElement('img');
          img.src = currentStaticAvatar;
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        }
      } else {
        // –î–ª—è —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ‚Äì —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥–∞–≤ —Å—Ç–∞—Ç–∏—á–Ω–∏–π –∞–≤–∞—Ç–∞—Ä
        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        } else {
          const img = document.createElement('img');
          img.src = 'default-avatar.png';
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        }
      }

      let displayName = username;
      if (prefix && prefix.trim() !== "") {
        displayName = prefix + " " + username;
      }
      avatarContainer.appendChild(document.createTextNode(`${displayName}: ${message}`));
      p.appendChild(avatarContainer);
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displaySticker(username, stickerUrl) {
      const p = document.createElement('p');
      const img = document.createElement('img');
      img.src = stickerUrl;
      img.alt = "–ù–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π —Å—Ç—ñ–∫–µ—Ä";
      img.classList.add('sticker-image');
      p.appendChild(document.createTextNode(`${username} –Ω–∞–¥—ñ—Å–ª–∞–≤ —Å—Ç—ñ–∫–µ—Ä:`));
      p.appendChild(img);
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displayPrivate(from, message, avatar) {
      const p = document.createElement('p');
      const avatarContainer = document.createElement('span');

      if (from === currentUsername) {
        if (currentVideoAvatar) {
          const videoEl = document.createElement('video');
          videoEl.src = currentVideoAvatar;
          videoEl.width = 50;
          videoEl.height = 50;
          videoEl.autoplay = true;
          videoEl.loop = true;
          videoEl.muted = true;
          videoEl.style.marginRight = "5px";
          avatarContainer.appendChild(videoEl);
        } else if (currentStaticAvatar) {
          const img = document.createElement('img');
          img.src = currentStaticAvatar;
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        }
      } else {
        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        } else {
          const img = document.createElement('img');
          img.src = 'default-avatar.png';
          img.width = 50;
          img.height = 50;
          img.style.marginRight = "5px";
          avatarContainer.appendChild(img);
        }
      }
      let displayName = (from === currentUsername) ? "–í–∏" : from;
      avatarContainer.appendChild(document.createTextNode(`${displayName}: ${message}`));
      p.appendChild(avatarContainer);
      messagesP.appendChild(p);
      messagesP.scrollTop = messagesP.scrollHeight;
    }

    /*****************************************************************
     * 9. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É, –ø—Ä–æ—Ñ—ñ–ª—é    *
     *****************************************************************/
    function loadFriendList() {
      ws.send(JSON.stringify({ 
        action: 'loadUserList', 
        username: currentUsername,
        ip: clientIP
      }));
    }

    function loadUserList(users) {
      usernameToBan.innerHTML = '';
      checkboxUsers.innerHTML = '';
      users.forEach(user => {
        const banOption = document.createElement('option');
        banOption.id = user;
        banOption.value = user;
        banOption.text = user;
        usernameToBan.appendChild(banOption);

        const opt = document.createElement('option');
        opt.value = user;
        opt.text = user;
        checkboxUsers.appendChild(opt);
      });
    }

    function loadChatHistory() {
      ws.send(JSON.stringify({ 
        action: 'loadChatHistory', 
        username: currentUsername,
        ip: clientIP
      }));
    }

    function loadProfile() {
      if (ws && currentUsername) {
        ws.send(JSON.stringify({ 
          action: 'get_profile', 
          username: currentUsername,
          ip: clientIP
        }));
      }
    }

    /*****************************************************************
     * 10. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é (–∫–Ω–æ–ø–∫–∞ "–ó–±–µ—Ä–µ–≥—Ç–∏" —É –ø—Ä–æ—Ñ—ñ–ª—ñ)          *
     *****************************************************************/
    saveAbout.addEventListener('click', () => {
      const aboutText = editAbout.value.trim();
      if (!aboutText) {
        // –ú–æ–∂–Ω–∞ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –ø—É—Å—Ç–∏–π —Ä—è–¥–æ–∫ –∞–±–æ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—Ç–∏
      }
      ws.send(JSON.stringify({
        action: 'update_profile',
        username: currentUsername,
        about: aboutText,
        ip: clientIP
      }));
    });

    /*****************************************************************
     * 11. –ê–¥–º—ñ–Ω-—Ñ—É–Ω–∫—Ü—ñ—è –±–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞                            *
     *****************************************************************/
    function TryToBanUser() {
      const sel_val = usernameToBan.value.trim();
      if (sel_val === 'hideyoshi.xaotiq') {
        alertify.error('–í–∏ –Ω–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.');
        return;
      }
      const tokenprompt = prompt('–í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –≤–∑–∞—î–º–æ–¥—ñ—ó');
      const resn = prompt('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É');
      ws.send(JSON.stringify({ 
        action: 'ban_user', 
        username: sel_val, 
        duration: 10, 
        token: tokenprompt, 
        reason: resn, 
        banned_by: currentUsername,
        ip: clientIP
      }));
    }

  </script>

  <!-- –ü–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ –∑ "https://" -->
  <script>
    document.addEventListener('click', function(e) {
      const anchor = e.target.closest('a');
      if (anchor) {
        const href = anchor.getAttribute('href');
        if (href && href.startsWith('https://')) {
          e.preventDefault();
          window.location.href = '/redirect?s=' + encodeURIComponent(href);
        }
      }
    });
  </script>
</body>
</html>
