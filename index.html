<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCS –ú–µ—Å–µ–Ω–¥–∂–µ—Ä - —Ç–≤–æ—Ä—ñ–Ω–Ω—è xaotiq</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css" />
</head>

<body>
    <div id="login-section">
        <div class="wrapper">
            <div class="card-switch">
                <label class="switch">
                    <input type="checkbox" class="toggle">
                    <span class="slider"></span>
                    <span class="card-side"></span>
                    <div class="flip-card__inner">
                        <div class="flip-card__front">
                            <div class="title">WCS - –í—Ö—ñ–¥</div>
                            <div class="flip-card__form">
                                <input class="flip-card__input" id="username" placeholder="–ù—ñ–∫–Ω–µ–π–º" type="text">
                                <input class="flip-card__input" id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
                                <button class="flip-card__btn" id="loginButton">–í–≤—ñ–π—Ç–∏</button>
                            </div>
                        </div>
                        <div class="flip-card__back">
                            <div class="title">WCS - –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
                            <div class="flip-card__form">
                                <input class="flip-card__input" id="usernameR" placeholder="–ù—ñ–∫–Ω–µ–π–º" type="text">
                                <input class="flip-card__input" id="passwordR" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
                                <button id="registerButton" class="flip-card__btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
    </div>

    <div id="chat-section" class="hidden">
        <h3>–í—ñ—Ç–∞—é, <span id="user-welcome"></span>!</h3>
        <div id="chat-area">
            <div id="messages"></div>
            <input type="text" id="message" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
            <button id="send-button">üì©</button>
        </div>
    </div>

    <div class="hidden" id="private-section">
        <div id="messagesP"></div>
        <p id="chosen-user"></p>
        <div id="checkbox-users">
            <div class="sidenav" id="usernav"></div>
        </div>
        <div id="privatemsg">
        <input type="text" id="prvamsg">
        <button id="send-private">üì©</button>
    </div>
    </div>

    <div class="hidden" id="radio-section">
        <label class="radio">
            <input type="radio" name="radio" checked="" value="forum">
            <span class="name">–§–æ—Ä—É–º</span>
        </label>
        <label class="radio">
            <input type="radio" name="radio" value="private">
            <span class="name">–ü—Ä–∏–≤–∞—Ç–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</span>

        </label>
    </div>

    <script>
        let ws;
        let currentUsername;

        const loginSection = document.getElementById('login-section');
        const chatSection = document.getElementById('chat-section');
        const messagesDiv = document.getElementById('messages');
        const loginButton = document.getElementById('loginButton');
        const sendButton = document.getElementById('send-button');
        const userWelcome = document.getElementById('user-welcome');
        const registerButton = document.getElementById('registerButton');
        const radioSection = document.getElementById('radio-section');
        const privateSection = document.getElementById('private-section');
        const sendPrivate = document.getElementById('send-private');
        const prvmsg = document.getElementById('prvamsg');
        const userNav = document.getElementById('usernav');
        const chosenUser = document.getElementById('chosen-user');
        const messagesP = document.getElementById('messagesP')
        privateSection.style.display = 'none';

        const radios = document.querySelectorAll('input[name="radio"]');
        const url = "ws://127.0.0.1:2573";

        radios.forEach(radio => {
            radio.addEventListener('change', function () {
                const selectedValue = document.querySelector('input[name="radio"]:checked').value;
                if (selectedValue === "forum") {
                    chatSection.style.display = 'flex';
                    privateSection.style.display = 'none';
                } else {
                    chatSection.style.display = 'none';
                    privateSection.style.display = 'flex';
                }
            });
        });

        registerButton.addEventListener('click', () => {
            const username = document.getElementById('usernameR').value;
            const password = document.getElementById('passwordR').value;

            ws = new WebSocket(url);
            ws.onopen = () => {
                ws.send(JSON.stringify({ action: 'create_account', username, password }));
            };

            ws.onmessage = (event) => {
                const response = JSON.parse(event.data);
                if (response.action === 'createAccount') {
                    if (response.success) {
                        alertify.success('–í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å, —Ç–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –≤–≤—ñ–π—Ç–∏.');
                    } else {
                        alertify.alert(response.message);
                    }
                }
            };
        });

        loginButton.addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            ws = new WebSocket(url);
            ws.onopen = () => {
                ws.send(JSON.stringify({ action: 'login', username, password }));
            };

            ws.onmessage = (event) => {
                const response = JSON.parse(event.data);
                console.log(response)

                if (response.action === 'login') {
                    if (response.success) {
                        currentUsername = username;
                        loginSection.classList.add('hidden');
                        chatSection.classList.remove('hidden');
                        privateSection.classList.remove('hidden');
                        radioSection.classList.remove('hidden');
                        radioSection.classList.add('radio-inputs');
                        chatSection.classList.add('gcard');
                        privateSection.classList.add('gcard');
                        userWelcome.textContent = currentUsername;

                        loadFriendList();
                        loadChatHistory();
                    } else {
                        alertify.error('–ü–æ–º–∏–ª–∫–∞ 129: –ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ –≤—Ö–æ–¥—É / —Å–µ—Å—ñ—è –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–∞');
                    }
                } else if (response.action === 'new_message') {
                    displayMessage(response.username, response.message);
                } else if (response.action === 'loadFriendList') {
                    updateFriendList(response.friends);

                } else if (response.action === 'loadUserList' && Array.isArray(response.users)) {
                    loadUserList(response.users);
                } else if (response.action === 'loadChatHistory') {
                    response.chatHistory.forEach(msg => {
                        displayMessage(msg.username, msg.message);
                    });
                } else if (response.action === 'private_message') {
                    console.log(response)
                    
                    if (response.recipient === currentUsername) {

                        displayMessage('',response.message);
                        displayPrivate(response.message);

                    }
                    else if (response.username === currentUsername) {
                        displayMessage('',response.message);
                        displayPrivate(response.message);
                    }
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        });

        sendButton.addEventListener('click', () => {
            const message = document.getElementById('message').value;
            if (message.trim()) {
                ws.send(JSON.stringify({ action: 'send_message', username: currentUsername, message }));
                document.getElementById('message').value = '';
            }
        });

        sendPrivate.addEventListener('click', () => {
            const message = prvmsg.value.trim();
            console.log(message) // Trim whitespace to ensure no empty messages
            const recipient = chosenUser.textContent.trim(); // Get the recipient from the selected user

            if (message && recipient) {  // Ensure both message and recipient are present
                sendPrivateMessage(message);
                 // Pass recipient and message to the function
                prvmsg.value = ''; // Clear input after sending
            } else {
                alertify.error('Recipient or message cannot be empty.');
            }
        });
        function displayMessage(username, message) {
            const p = document.createElement('p');
            p.textContent = `${username}: ${message}`;
            messagesDiv.appendChild(p);
        }
        function displayPrivate(message) {
            const p = document.createElement('p');
            p.textContent = `${message}`;
            messagesP.appendChild(p);
        }

        function loadFriendList() {
            ws.send(JSON.stringify({ action: 'loadUserList', username: currentUsername }));
        }


        function loadUserList(users) {
            //const userNav = document.getElementById('userNav');
            userNav.innerHTML = ''; // Clear any existing avatars

            users.forEach(user => {
                const userName = `${user}`; // Assumed user object structure
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;

                // Create an img element for each avatar
                const imgElement = document.createElement('img');
                imgElement.src = avatarUrl;
                imgElement.alt = userName;
                imgElement.className = 'user-avatar';
                imgElement.id = `user-avatar-${user.id}`;

                // Add click event to handle avatar clicks (for example, display user details)
                imgElement.addEventListener('click', () => {
                    console.log(user)
                    chosenUser.textContent = user;
                });

                // Append the avatar to the userNav container
                userNav.appendChild(imgElement);
            });
        }

        function loadChatHistory() {
            ws.send(JSON.stringify({ action: 'loadChatHistory', username: currentUsername }));
        }

        function sendPrivateMessage(message) {
            console.log(JSON.stringify({ action: 'private_message', username: currentUsername, recipient: chosenUser.textContent, message:message }));
            ws.send(JSON.stringify({ action: 'private_message', username: currentUsername, recipient: chosenUser.textContent, message:message }));
            displayPrivate(`[–≤—ñ–¥ –í–∏ –¥–æ ${recipient}] : ${message}`);
        }

        function updateFriendList(friends) {
            userNav.innerHTML = '';
            friends.forEach((friend, index) => {
                const backgroundColors = ['3498db', 'e74c3c', '9b59b6', '1abc9c', 'f39c12'];
                const colorIndex = index % backgroundColors.length;
                const avatarUrl = `https://ui-avatars.com/api/?name=${friend.split(' ').join('+')}&background=${backgroundColors[colorIndex]}&color=ffffff&size=100`;

                const a = document.createElement('a');
                a.href = '#';
                a.classList.add('nav-item');

                const img = document.createElement('img');
                img.src = avatarUrl;
                img.alt = 'User Avatar';

                a.appendChild(img);
                userNav.appendChild(a);
            });
        }

        async function decryptMessage(encryptedMessage) {
            return encryptedMessage; // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        }
    </script>
</body>

</html>
